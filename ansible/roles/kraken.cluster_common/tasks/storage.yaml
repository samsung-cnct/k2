---
- name: "Generate format service unit" 
  set_fact:
    cloud_config: "{{ cloud_config | combine(new_data, recursive=True) }}"
  vars:
    unit:
      "{{ lookup('template','format-storage.part.jinja2') | from_yaml }}"
    units: "{{ cloud_config[cluster.name][node.name].units | default([]) + unit }}"
    new_data: '{{ { cluster.name: { node.name: { "units": units } } } }}'
  when: node.nodeConfig.mounts is defined

- name: "Generate mount service unit" 
  set_fact:
    cloud_config: "{{ cloud_config | combine(new_data, recursive=True) }}"
  vars:
    unit:
      "{{ lookup('template','mount.part.jinja2') | from_yaml }}"
    units: "{{ cloud_config[cluster.name][node.name].units | default([]) + unit }}"
    new_data: '{{ { cluster.name: { node.name: { "units": units } } } }}'
  when: node.nodeConfig.mounts is defined
