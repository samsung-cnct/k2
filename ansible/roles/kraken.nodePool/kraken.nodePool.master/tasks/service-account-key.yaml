---
- name: Make sure generated folder for generated key is there
  file:
    path: "{{ config_base }}/{{ cluster.name }}/certs"
    state: directory

- name: Generate ServiceAccount key
  openssl_privatekey:
    path: "{{ config_base | expanduser }}/{{ cluster.name }}/certs/service-account.pem"
    size: 2048

- name: Extract ServiceAccount public key
  openssl_publickey:
    privatekey_path: "{{ config_base | expanduser }}/{{ cluster.name }}/certs/service-account.pem"
    path: "{{ config_base | expanduser }}/{{ cluster.name }}/certs/service-account-pub.pem"

# This write_files is not generated by template and can remain a special case
- name: Generate master serviceAccount pem write_files
  set_fact:
    cloud_config: "{{ cloud_config | combine(new_data, recursive=True) }}"
  vars:
    write_file:
      - path: /etc/kubernetes/ssl/service-account-key.pem
        content: "{{ lookup('file', '{{config_base}}/{{ cluster.name }}/certs/service-account.pem' | expanduser) }}"
    write_files: "{{ cloud_config[cluster.name][node.name].write_files | default([]) + write_file }}"
    new_data: '{{ { cluster.name: { node.name: { "write_files": write_files } } } }}'