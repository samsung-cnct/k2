---

- debug:
    msg: "UNICORNS STAMPEDING UPDATE"


- name: Set list of nodepools to be updated
  set_fact:
    nodepools_to_update: "{{ update_nodepools.split(',') }}"

- debug:
    msg: "nodepools I want to update: {{nodepools_to_update}}"

- debug:
    msg: "all cluster nodepools: {{cluster.nodePools}}"

- name: Fail when no nodepools were passed to update
  fail:
    msg: "Argument empty. Please pass --nodepools <comma,separated,list,of,nodepools> to update action."
  when: update_nodepools == ""

- name: Update master, if needed
  command: >
    gcloud container clusters upgrade {{ cluster.name }}
      --master
      --project {{ cluster.providerConfig.project }}
      --zone {{ cluster.providerConfig.zone.primaryZone }}
      --no-async
      --quiet
  when: (cluster.providerConfig.kubeConfig is defined) and (cluster.providerConfig.kubeConfig.version is defined)

- name: Update nodepools, if needed
  command: >
    gcloud container clusters upgrade {{ cluster.name }}
      --node-pool {{ item.name }}
      --cluster-version {{ item.kubeConfig.version | replace("v","")}}
      --project {{ cluster.providerConfig.project }}
      --zone {{ cluster.providerConfig.zone.primaryZone }}
      --no-async
      --quiet
  when: (item.kubeConfig is defined) and (item.kubeConfig.version is defined) and (item.name in nodepools_to_update)
  with_items: "{{ cluster.nodePools }}"
