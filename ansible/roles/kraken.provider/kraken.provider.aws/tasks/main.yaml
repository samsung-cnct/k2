---
- name:
  set_fact:
    cluster: "{{ a_cluster }}"
    ssl_cert_common_name: "*.{{ cluster.providerConfig.region }}.elb.amazonaws.com"

- include: aws-certs.yaml
  when: kraken_action == 'up'

# Terraform resources which have prevent_destroy set to true will not be
# destroyed, even when `terraform destroy` is called. To avoid the potential
# for infrastructure data loss, some resources are only allowed to be deleted
# when all of the infrastructure is being destroyed by the down action.
- include: aws-template.yaml
  vars:
    prevent_destroy: "{{ 'false' if kraken_action == 'down' else 'true' }}"

- include: aws-action-dryrun.yaml
  when:  (dryrun | bool)

- stat:
    path: "{{ config_base | expanduser }}/{{ cluster.name }}/etcd.status.lock"
  register: etcd_status_lock_file

- name: Terraform apply etcd nodes
  include: terraform-apply-etcd.yaml
  when:
    - not etcd_status_lock_file.stat.exists
    - kraken_action == 'up'
    - not (dryrun | bool)

#- name: Wait for etcd nodes to form cluster

- name: Terraform apply/destroy k8s nodes
  include: aws-action.yaml
  when: not (dryrun | bool)
